<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Indian Market of Agricultural Product</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style_graph.css') }}">
</head>
<body>
  <div class="container">
    <h2>Agricultural Product Prices</h2>
    <div id="info">Click on legend labels to drill down.</div>
    <div>
      <div class="select-group">
        <label for="productSelect">Select a product:</label>
        <select id="productSelect">
          <option value="" disabled selected>— Choose Product —</option>
        </select>
      </div>
      <button id="backButton">Back to Previous level</button>
      <button id="resetButton" style="display: none;">Back to Base view</button>
    </div>
    <div id="levelTitle">Indian Market of “…”</div>
    <div class="chart-wrapper">
      <div class="chart-area">
        <canvas id="priceChart"></canvas>
      </div>
      <div id="stats" class="stats-box">
        <h3>Statistics</h3>
        <p>No data</p>
      </div>
    </div>
    <div class="legend-wrapper" id="legendWrapper">
      <ul class="custom-legend" id="chartLegend"></ul>
    </div>
  </div>

  <script id="chart-data" type="application/json">{{ data | safe }}</script>
  <script>
    const selectedProduct = {{ selected_product|tojson|safe }};
    const selectedState = {{ selected_state|tojson|safe }};
    const rawData = JSON.parse(document.getElementById('chart-data').textContent);

    const select = document.getElementById('productSelect');
    const ctx = document.getElementById('priceChart').getContext('2d');
    const backButton = document.getElementById('backButton');
    const resetButton = document.getElementById('resetButton');
    const legendContainer = document.getElementById('chartLegend');
    const levelTitle = document.getElementById('levelTitle');
    const statsBox = document.getElementById('stats');

    let currentChart = null;
    let drillState = [];
    let currentProduct = null;
    let currentState = null;
    let currentDistrict = null;
    let currentLevel = null;
    const colorPool = {};

    const generateColor = () => `rgb(${Math.random()*200|0},${Math.random()*200|0},${Math.random()*200|0})`;

    // Popola la select dei prodotti
    Object.keys(rawData).forEach(product => {
      const opt = document.createElement('option');
      opt.value = product;
      opt.text = product;
      select.appendChild(opt);
    });

    // --- RENDERING ---

    function drawChart(datasets, product, level) {
      currentLevel = level;
      if (currentChart) currentChart.destroy();
      currentChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          parsing: { xAxisKey: 'x', yAxisKey: 'y' },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day', tooltipFormat: 'dd-MM-yyyy', displayFormats: { day: 'dd-MM-yyyy' } },
              title: { display: true, text: 'Date' }
            },
            y: {
              title: { display: true, text: 'Average Price' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true, mode: 'nearest' }
          }
        }
      });

      // Legenda interattiva
      legendContainer.innerHTML = '';
      datasets.forEach((ds, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<div class="legend-box" style="background-color:${ds.borderColor}"></div>
                        <span class="label-text">${ds.label}</span>`;

        li.addEventListener('mouseenter', () => {
          currentChart.data.datasets.forEach((_, i) => {
            currentChart.setDatasetVisibility(i, i === idx);
          });
          currentChart.update();
        });

        li.addEventListener('mouseleave', () => {
          currentChart.data.datasets.forEach((_, i) => {
            currentChart.setDatasetVisibility(i, true);
          });
          currentChart.update();
        });
        
        li.addEventListener('click', () => {
          if (currentLevel === 'aggregated') {
           renderChart(product);
          } else if (currentLevel === 'state') {
            renderDistricts(product, ds.label);
          } else if (currentLevel === 'district') {
            renderMarkets(product, ds.label);
          }
        });

        

        legendContainer.appendChild(li);
      });
    }

    function updateStats(datasets, level) {
      if (!datasets.length) {
        statsBox.innerHTML = '<h3>Statistics</h3><p>No data</p>';
        return;
      }

      let min = Infinity, max = -Infinity, minLabel = '', maxLabel = '', minDate = '', maxDate = '';
      datasets.forEach(ds => {
        ds.data.forEach(p => {
          if (p.y < min) { min = p.y; minLabel = ds.label; minDate = p.x; }
          if (p.y > max) { max = p.y; maxLabel = ds.label; maxDate = p.x; }
        });
      });

      statsBox.innerHTML = `
        <h3>Price Statistics</h3>
        <p>Product: <span>${currentProduct}</span></p>
        <p>Level Selected: <span>${level.charAt(0).toUpperCase() + level.slice(1)}</span></p>
        <p>Lowest Price: <span>${minLabel}</span> on <span>${minDate}</span> (${min.toFixed(2)})</p>
        <p>Highest Price: <span>${maxLabel}</span> on <span>${maxDate}</span> (${max.toFixed(2)})</p>`;
    }

    function renderAggregatedChart(product) {
      currentProduct = product;
      currentState = null;
      currentDistrict = null;
      drillState = [];
      backButton.style.display = 'none';
      resetButton.style.display = 'none';
      legendContainer.innerHTML = '';
      statsBox.innerHTML = '<h3>Statistics</h3><p>No data</p>';
      levelTitle.textContent = `Indian Avg. Price of ${product}`;

      const averagedData = rawData[product].aggregated;
      const datasets = [{
        label: `${product} (Indian Avg.)`,
        data: averagedData,
        borderWidth: 2,
        fill: false,
        borderColor: 'black'
      }];
      drawChart(datasets, product, 'aggregated');
      updateStats(datasets, 'Country');
    }

    function renderChart(product) {
      currentProduct = product;
      currentState = null;
      currentDistrict = null;
      drillState = [];
      backButton.style.display = 'none';
      resetButton.style.display = 'inline-block';
      legendContainer.innerHTML = '';
      statsBox.innerHTML = '<h3>Statistics</h3><p>No data</p>';
      levelTitle.textContent = `State Markets of ${product}`;

      const datasets = Object.entries(rawData[product].states).map(([state, values]) => ({
        label: state,
        data: values,
        borderWidth: 2,
        fill: false,
        borderColor: colorPool[state] || (colorPool[state] = generateColor())
      }));

      drawChart(datasets, product, 'state');
      updateStats(datasets, 'state');
    }

    function renderDistricts(product, state) {
      currentProduct = product;
      currentState = state;
      currentDistrict = null;
      drillState.push(() => renderChart(product));
      backButton.style.display = 'inline-block';
      levelTitle.textContent = `State of ${state} Market of ${product}`;
      legendContainer.innerHTML = '';
      statsBox.innerHTML = '<h3>Statistics</h3><p>No data</p>';

      const datasets = Object.entries(rawData[product].districts[state] || {}).map(([district, values]) => ({
        label: district,
        data: values,
        borderWidth: 2,
        fill: false,
        borderColor: colorPool[district] || (colorPool[district] = generateColor())
      }));

      drawChart(datasets, product, 'district');
      updateStats(datasets, 'district');
    }

    function renderMarkets(product, district) {
      currentDistrict = district;
      drillState.push(() => renderDistricts(product, currentState));
      backButton.style.display = 'inline-block';
      levelTitle.textContent = `District of ${district} Market of ${product}`;
      legendContainer.innerHTML = '';
      statsBox.innerHTML = '<h3>Statistics</h3><p>No data</p>';

      const datasets = Object.entries(rawData[product].markets[district] || {}).map(([market, values]) => ({
        label: market,
        data: values,
        borderWidth: 2,
        fill: false,
        borderColor: colorPool[market] || (colorPool[market] = generateColor())
      }));

      drawChart(datasets, product, 'market');
      updateStats(datasets, 'market');
    }

    // --- EVENTI ---
    select.addEventListener('change', () => {
      renderChart(select.value);
    });

    backButton.addEventListener('click', () => {
      if (drillState.length > 0) {
        const last = drillState.pop();
        last();
        if (drillState.length === 0) backButton.style.display = 'none';
      }
    });

    resetButton.addEventListener('click', () => {
    if (currentProduct) renderChart(currentProduct); // mostra subito livello state
    });

    // --- AVVIO AUTOMATICO ---
    // --- AVVIO AUTOMATICO ---
if (selectedProduct && selectedState && rawData[selectedProduct]?.states[selectedState]) {
  select.value = selectedProduct;
  
  // Solo un dataset per quello stato
  currentProduct = selectedProduct;
  currentState = selectedState;
  currentDistrict = null;
  drillState = [];

  const datasets = [{
    label: selectedState,
    data: rawData[selectedProduct].states[selectedState],
    borderWidth: 2,
    fill: false,
    borderColor: colorPool[selectedState] || (colorPool[selectedState] = generateColor())
  }];

  levelTitle.textContent = `State Markets of ${selectedProduct}`;
  backButton.style.display = 'none';
  resetButton.style.display = 'inline-block';
  drawChart(datasets, selectedProduct, 'state');
  updateStats(datasets, 'state');

} else if (selectedProduct && rawData[selectedProduct]) {
  select.value = selectedProduct;
  renderChart(selectedProduct);
}
  </script>

  <a href="/logout_admin" class="logout-btn">Logout</a>
  <button onclick="goBackAndReload()" class="back-btn">⬅️ Back to Previous Page</button>
  <script>
    function goBackAndReload() {
      const referrer = document.referrer;
      if (referrer) window.location.href = referrer;
      else window.history.back();
    }
  </script>
</body>
</html>
